generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Branch {
  id             String              @id @default(uuid())
  name           String
  code           String              @unique
  address        String?
  phone          String?
  email          String?
  managerName    String?
  status         String              @default("ACTIVE")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  customers      Customer[]
  distribution   DistributionOrder[]
  expenses       Expense[]
  payables       Payable[]
  products       Product[]
  purchaseOrders PurchaseOrder[]
  receivables    Receivable[]
  sales          Sale[]
  scannerLogs    ScannerHistory[]
  suppliers      Supplier[]
  transactions   Transaction[]
  users          User[]
}

model User {
  id           String           @id @default(uuid())
  name         String
  email        String           @unique
  passwordHash String
  role         String           @default("CASHIER")
  avatarUrl    String?
  branchId     String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  sales        Sale[]           @relation("SaleCashier")
  scannerLogs  ScannerHistory[]
  branch       Branch?          @relation(fields: [branchId], references: [id])
}

model Product {
  id                   String             @id @default(uuid())
  branchId             String
  sku                  String             @unique
  gtin                 String?
  shortCode            String?
  nameEn               String
  nameMm               String
  genericName          String?
  category             String
  description          String?
  price                Int
  unit                 String
  stockLevel           Int                @default(0)
  minStockLevel        Int                @default(0)
  requiresPrescription Boolean            @default(false)
  imageUrl             String?
  location             String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  distributionItems    DistributionItem[]
  branch               Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  batches              ProductBatch[]
  purchaseItems        PurchaseItem[]
  saleItems            SaleItem[]

  @@index([branchId])
  @@index([category])
  @@index([shortCode])
}

model ProductBatch {
  id          String     @id @default(uuid())
  productId   String
  batchNumber String
  expiryDate  DateTime
  quantity    Int        @default(0)
  costPrice   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems   SaleItem[]

  @@unique([productId, batchNumber])
}

model Customer {
  id        String   @id @default(uuid())
  branchId  String
  name      String
  phone     String   @unique
  points    Int      @default(0)
  tier      String   @default("Silver")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  sales     Sale[]

  @@index([branchId])
}

model Supplier {
  id             String          @id @default(uuid())
  branchId       String
  name           String
  contact        String?
  email          String?
  creditLimit    Int             @default(0)
  outstanding    Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  payables       Payable[]
  purchaseOrders PurchaseOrder[]
  branch         Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model PurchaseOrder {
  id          String         @id @default(uuid())
  branchId    String
  supplierId  String
  status      String         @default("PENDING")
  paymentType String         @default("CASH")
  date        DateTime       @default(now())
  totalAmount Int            @default(0)
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  items       PurchaseItem[]
  supplier    Supplier       @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  branch      Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model PurchaseItem {
  id         String        @id @default(uuid())
  purchaseId String
  productId  String?
  name       String
  quantity   Int
  unitCost   Int
  product    Product?      @relation(fields: [productId], references: [id])
  purchase   PurchaseOrder @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
}

model DistributionOrder {
  id           String             @id @default(uuid())
  branchId     String
  customerName String
  address      String
  status       String             @default("PENDING")
  total        Int                @default(0)
  date         DateTime           @default(now())
  deliveryTime String?
  paymentType  String             @default("CASH")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  items        DistributionItem[]
  branch       Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model DistributionItem {
  id        String            @id @default(uuid())
  orderId   String
  productId String?
  name      String
  quantity  Int
  price     Int
  product   Product?          @relation(fields: [productId], references: [id])
  order     DistributionOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Transaction {
  id            String   @id @default(uuid())
  branchId      String
  type          String
  category      String
  amount        Int
  date          DateTime @default(now())
  description   String?
  paymentMethod String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  branch        Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model Expense {
  id          String   @id @default(uuid())
  branchId    String
  category    String
  amount      Int
  date        DateTime
  description String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model Payable {
  id           String    @id @default(uuid())
  branchId     String
  supplierId   String?
  supplierName String
  invoiceNo    String
  amount       Int
  dueDate      DateTime
  status       String    @default("NORMAL")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  branch       Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model Receivable {
  id           String   @id @default(uuid())
  branchId     String
  customerName String
  orderRef     String
  amount       Int
  dueDate      DateTime
  status       String   @default("NORMAL")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  branch       Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
}

model Sale {
  id            String     @id @default(uuid())
  branchId      String
  customerId    String?
  cashierId     String?
  total         Int
  paymentMethod String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  cashier       User?      @relation("SaleCashier", fields: [cashierId], references: [id])
  customer      Customer?  @relation(fields: [customerId], references: [id])
  branch        Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  items         SaleItem[]
}

model SaleItem {
  id        String        @id @default(uuid())
  saleId    String
  productId String
  quantity  Int
  unitPrice Int
  batchId   String?
  batch     ProductBatch? @relation(fields: [batchId], references: [id])
  product   Product       @relation(fields: [productId], references: [id])
  sale      Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
}

model AppSetting {
  id                   Int      @id @default(autoincrement())
  companyName          String   @default("Ko Hnit Aung Pharmacy")
  taxId                String?
  phone                String?
  email                String?
  address              String?
  language             String   @default("English")
  shopNameReceipt      String   @default("Ko Hnit Aung Pharmacy")
  receiptFooter        String   @default("Thank you for your purchase!")
  paperSize            String   @default("80mm")
  defaultPrinter       String   @default("System Default")
  autoPrint            Boolean  @default(false)
  showImages           Boolean  @default(true)
  lowStockLimit        Int      @default(10)
  expiryWarningDays    Int      @default(90)
  expiryCriticalDays   Int      @default(180)
  enableEmailReports   Boolean  @default(false)
  enableCriticalAlerts Boolean  @default(true)
  notificationEmail    String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model ScannerHistory {
  id           String    @id @default(uuid())
  branchId     String
  userId       String?
  gtin         String?
  productName  String?
  batchNumber  String?
  expiryDate   DateTime?
  serialNumber String?
  quantity     Int       @default(0)
  unit         String?
  syncStatus   String    @default("PENDING")
  syncMessage  String?
  rawData      String
  verified     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  user         User?     @relation(fields: [userId], references: [id])
  branch       Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  logs         SyncLog[]
}

model SyncLog {
  id          String         @id @default(uuid())
  scanId      String
  action      String
  productName String?
  oldQuantity Int?
  newQuantity Int?
  status      String         @default("SUCCESS")
  createdAt   DateTime       @default(now())
  scan        ScannerHistory @relation(fields: [scanId], references: [id], onDelete: Cascade)
}
